{% extends 'base.html' %}

{% block title %}Registrar Compra - Sistema Cafeteria{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-cart-plus"></i> Registrar Compra</h2>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Datos de la Compra</h5>
    </div>
    <div class="card-body">
        <form method="POST">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Producto</label>
                    <select name="producto_id" id="producto_select" class="form-select" required>
                        <option value="">Seleccionar producto...</option>
                        {% for p in productos %}
                        <option value="{{ p.id }}">{{ p.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Proveedor</label>
                    <select name="proveedor" id="proveedor_select" class="form-select" required>
                        <option value="">Primero selecciona un producto</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Tiempo Entrega (dias)</label>
                    <input type="number" name="tiempo_entrega" id="tiempo_entrega" class="form-control" value="1" min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cantidad (paquetes)</label>
                    <input type="number" name="cantidad" id="cantidad" class="form-control" step="0.01" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Costo por Paquete ($)</label>
                    <input type="number" name="costo" id="costo" class="form-control" step="0.01" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">IVA (%)</label>
                    <input type="number" name="iva" id="iva" class="form-control" value="16" step="0.01">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary" onclick="calcularTotal()">
                        <i class="bi bi-calculator"></i> Calcular Total
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <h3 class="text-success" id="total_display">Total: $0.00</h3>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-check-circle"></i> CONFIRMAR COMPRA
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('producto_select').addEventListener('change', async function() {
    const productoId = this.value;
    const proveedorSelect = document.getElementById('proveedor_select');

    if (!productoId) {
        proveedorSelect.innerHTML = '<option value="">Primero selecciona un producto</option>';
        return;
    }

    try {
        const response = await fetch(`/api/producto/${productoId}/proveedores`);
        const proveedores = await response.json();

        if (proveedores.length === 0) {
            proveedorSelect.innerHTML = '<option value="">Sin proveedores asignados</option>';
            return;
        }

        proveedorSelect.innerHTML = proveedores.map(p =>
            `<option value="${p.nombre}" data-precio="${p.precio}" data-tiempo="${p.tiempo_entrega}">
                ${p.nombre} - $${p.precio.toFixed(2)} (${p.tiempo_entrega} dias)
            </option>`
        ).join('');

        // Auto-llenar precio y tiempo del primer proveedor
        const firstOption = proveedorSelect.options[0];
        document.getElementById('costo').value = firstOption.dataset.precio;
        document.getElementById('tiempo_entrega').value = firstOption.dataset.tiempo;

    } catch (error) {
        console.error('Error:', error);
        proveedorSelect.innerHTML = '<option value="">Error al cargar proveedores</option>';
    }
});

document.getElementById('proveedor_select').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    if (selected.dataset.precio) {
        document.getElementById('costo').value = selected.dataset.precio;
        document.getElementById('tiempo_entrega').value = selected.dataset.tiempo;
    }
});

function calcularTotal() {
    const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
    const costo = parseFloat(document.getElementById('costo').value) || 0;
    const iva = parseFloat(document.getElementById('iva').value) || 0;

    const subtotal = cantidad * costo;
    const total = subtotal * (1 + iva / 100);

    document.getElementById('total_display').textContent = `Total: $${total.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
}
</script>
{% endblock %}
